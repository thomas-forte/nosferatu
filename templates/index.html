{% extends "base.html" %}

{% block pageTitle %}{{ pageTitle }}{% endblock %}

{%block page %}
<div class="container d-flex flex-wrap justify-content-center">
  {% for wemo in wemos %}
  <button
    id="wemo-{{ wemo.key }}-button"
    class="btn btn-primary btn-block btn-lg px-4 m-3"
    type="button"
    style="min-width: 180px;"
    data-key="{{ wemo.key }}"
    data-name="{{ wemo.name }}"
  >
    {{ wemo.name }}
  </button>
  {% else %}
  <p>See the <a href="https://github.com/thomas-forte/nosferatu/blob/master/README.md">README</a> for project config</p>
  {% endfor %}
</div>

<div class="container d-flex flex-wrap justify-content-center">
  {% for pin in pins %}
  <button
    id="pin-{{ pin.key }}-button"
    class="btn btn-secondary btn-block btn-lg px-4 m-3"
    type="button"
    style="min-width: 180px;"
    data-key="{{ pin.pin }}"
    data-name="{{ pin.name }}"
  >
    {{ pin.name }}
  </button>
  {% else %}
  <p>See the <a href="https://github.com/thomas-forte/nosferatu/blob/master/README.md">README</a> for project config</p>
  {% endfor %}
</div>

<div
  id="alerts"
  class="fixed-top w-100 px-5 mt-5"
>
</div>
{% endblock %}

{% block pageScripts %}
<script type="text/javascript">
  const alertContainer = document.getElementById('alerts');

  const addAlert = (message, style = "success") => {
    const alertWrapper = document.createElement("div");
    alertWrapper.innerHTML = [
      `<div class="alert alert-${style} alert-dismissible d-flex align-items-center" role="alert">`,
      `   <i class="${style === 'success' ? 'fas fa-check-circle' : 'fas fa-exclamation-triangle'} me-2"></i>`,
      `   <div>${message}</div>`,
      '   <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>',
      '</div>'
    ].join('');
    alertContainer.append(alertWrapper);
    setTimeout(() => new bootstrap.Alert(alertWrapper.firstChild).close(), 3500)
  }

  const buttons = document.getElementsByTagName('button')

  for (const button of buttons) {
    button.addEventListener('click', async e => {
      e.preventDefault();
      if (button.id.includes('wemo')) {
        await fetch(`/wemo/${button.dataset.key}`)
          .then(response => response.text())
          .then(text => addAlert(`${button.dataset.name} turned ${text}`))
          .catch(() => addAlert(`${button.dataset.name} cycling failed`, 'danger'))
      } else {
        await fetch(`/gpio/${button.dataset.key}`)
          .then(response => response.text())
          .then(text => addAlert(`${button.dataset.name} turned ${text}`))
          .catch(() => addAlert(`${button.dataset.name} cycling failed`, 'danger'))
      }
      e.target.blur();
    });
  }
</script>
{% endblock %}